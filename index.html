<!DOCTYPE html>
<html lang="sv">
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />

  <title>Countdown</title>

  <link href="style.less" type="text/css" rel="stylesheet/less" />
  <link href="//fonts.googleapis.com/css?family=Lato:100,700" type="text/css" rel="stylesheet" />

  <script src="//fb.me/react-0.11.2.js"></script>
  <script src="//fb.me/JSXTransformer-0.11.2.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/less.js/1.7.5/less.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.3/moment.js"></script>

</head><body id="top" class="no-javascript">
<div id="wrapper">

  <div id="countdown" class="countdown" data-countdown-to="2014-12-24 00:00:01"></div>

</div>
<script type="text/jsx">
/** @jsx React.DOM **/

var CountdownSegment = React.createClass({

  render: function() {

    var segmentName = this.props.name;

    var zeroPad = function(num, size) {
      var zero = size - num.toString().length + 1;
      return Array(+(zero > 0 && zero)).join("0") + num;
    };

    if(this.props.data === 1) {

      segmentName = segmentName.slice(0, -1);

    }

    return (
      <span className={ 'countdown--segment countdown--segment_' + this.props.name }>
        <span className={'countdown--segment_data countdown--segment_' + this.props.name + '_data'}>
          { zeroPad(this.props.data, 2) }
        </span>
        <span className={'countdown--segment_name countdown--segment_' + this.props.name + '_name'}>
          { segmentName }
        </span>
      </span>
    );

  }

});

var Countdown = React.createClass({

  shouldRender: true,

  dateFormat: 'YYYY-MM-DD HH:mm:ss',

  dateSegmentsRelative: [
    'years',
    'months',
    'weeks',
    'days'
  ],

  dateSegments: [
    'days',
    'hours',
    'minutes',
    'seconds'
  ],

  calculateState: function() {

    var countdownTo = $('#countdown').data('countdown-to');
    var startDate = moment().format(this.dateFormat)
    var endDate = moment(countdownTo).isValid() ? moment(countdownTo, this.dateformat) : moment().format(this.dateFormat);
    var duration = moment.duration(endDate.diff(startDate));

    if(countdownTo === undefined) {

      this.shouldRender = false;

    }

    return {
      duration: duration,
      startDate: startDate,
      endDate: endDate
    };

  },

  getInitialState: function() {

    return this.calculateState();

  },

  componentDidMount: function() {

    this.tick();
    this.interval = setInterval(this.tick, 1000);

  },

  componentWillUnmount: function() {

    clearInterval(this.interval);

  },

  tick: function() {

    var startDate = this.state.startDate,
    endDate = this.state.endDate,
    diff = endDate.diff(startDate),
    duration = moment.duration(diff);

    this.setState({
      startDate: moment().format(this.dateFormat),
      duration: duration
    });

  },

  render: function() {

    var data,
      self = this,
      diff = {},
      segments = [],
      dateSegments = this.dateSegments,
      duration = this.state.duration;

    dateSegments.forEach(function(dateSegment) {

      if(self.dateSegmentsRelative.indexOf(dateSegment) === -1) {

        data = duration[dateSegment]();

      } else {

        data = duration.as(dateSegment);

      }

      data = Math.floor(data);
      diff[dateSegment] = data;

      segments.push(
        <CountdownSegment key={dateSegment} name={dateSegment} data={data} />
      );
    });

    if(this.shouldRender === false) {
      return (
        <div className="countdown--error">
          Cannot render component.
        </div>
      );
    }

    return (
      <div className="countdown--segments">
        {segments}
      </div>
    );

  }

});

React.renderComponent(
  <Countdown />,
  $('#countdown').get(0)
);
</script>
</div>
</body></html>
